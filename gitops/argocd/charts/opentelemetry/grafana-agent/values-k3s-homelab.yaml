# Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

---
# -- Additional annotations to add to all resources
additionalAnnotations: {}

# -- Additional labels to add to all resources
additionalLabels:
  portefaix.xyz/version: v0.46.0

grafana-agent:
  agent:
    configMap:
      create: true
      name: grafana-agent
      content: |-
        / ********************************************
          * OUTPUTS
          ********************************************/

        // [Local] Mimir

        mimir.remote_write "local" {
          endpoint {
            url = "http://mimir-nginx.monitoring.svc.cluster.local:80/api/v1/push"
          }
        }

        // [Grafana Cloud] Mimir

        mimir.write "grafana_cloud_mimir" {
          endpoint {
            url = "https://prometheus-us-central1.grafana.net/api/prom/push"
            basic_auth {
              username = env("GRAFANA_CLOUD_METRICS_ID")
              password = env("GRAFANA_CLOUD_METRICS_APIKEY")
            }
          }
        }

        // [Local] Loki

        loki.remote_write "local" {
          endpoint {
            url = "http://loki-gateway.logging.svc.cluster.local:80/loki/api/v1/push"
          }
        }

        // [Grafana Cloud] Loki

        loki.write "grafana_cloud_loki" {
          endpoint {
            url = "https://logs-prod-us-central1.grafana.net/loki/api/v1/push"
            basic_auth {
              username = env("GRAFANA_CLOUD_LOGS_ID")
              password = env("GRAFANA_CLOUD_LOGS_APIKEY")
              // username = local.file.loki_username.content
              // password = local.file.loki_password.content
            }
          }
        }

        // [Local] Tempo

        otelcol.exporter.otlp "tempo" {
          client {
            url = "tempo.tracing.svc.cluster.local:4317"
          }
        }

        // [Grafana Cloud] Tempo

        otelcol.auth.basic "grafana_cloud_tempo" {
          username = env("GRAFANA_CLOUD_TRACES_ID")
          password = env("GRAFANA_CLOUD_TRACES_APIKEY")
        }

        otelcol.exporter.otlp "grafana_cloud_tempo" {
          endpoint {
            url  = "tempo-us-central1.grafana.net:443"
            auth = otelcol.auth.basic.grafana_cloud_tempo.handler
          }
        }

        / ********************************************
          * INPUTS
          ********************************************/

        // ServiceMonitor
        prometheus.operator.servicemonitors "service_monitors" {
          // https://grafana.com/docs/agent/latest/flow/reference/components/prometheus.operator.servicemonitors/
          forward_to = [prometheus.remote_write.grafana_cloud_prometheus.receiver]
          selector {
            match_expression {
                key = "team"
                operator = "In"
                values = ["ops"]
            }
          }
        }

        // PodMonitor
        prometheus.operator.podmonitors "pod_monitors" {
          // https://grafana.com/docs/agent/latest/flow/reference/components/prometheus.operator.podmonitors/
          forward_to = [prometheus.remote_write.grafana_cloud_prometheus.receiver]
          selector {
            match_expression {
                key = "team"
                operator = "In"
                values = ["ops"]
            }
          }
        }

        // OpenTelemetry

        otelcol.exporter.loki "local" {
          // https://grafana.com/docs/agent/latest/flow/reference/components/otelcol.exporter.loki/
          forward_to = [loki.write.local.receiver]
        }

        otelcol.exporter.mimir "local" {
          // https://grafana.com/docs/agent/latest/flow/reference/components/otelcol.exporter.prometheus/
          forward_to = [mimir.remote_write.local.receiver]
        }

        otelcol.exporter.tempo "local" {
          // https://grafana.com/docs/agent/latest/flow/reference/components/otelcol.exporter.otlp/
          forward_to = [otelcol.exporter.otlp.tempo.receiver]
        }

        otelcol.receiver.otlp "core" {
          grpc {
            endpoint = "0.0.0.0:4317"
          }
          http {
            endpoint = "0.0.0.0:4318"
          }

          output {
            metrics = [otelcol.processor.batch.core.input]
            logs    = [otelcol.processor.batch.core.input]
            traces  = [otelcol.processor.batch.core.input]
          }
        }

        otelcol.processor.batch "core" {
          // https://grafana.com/docs/agent/latest/flow/reference/components/otelcol.processor.batch/
          output {
            metrics = [otelcol.processor.memory_limiter.core.input]
            logs    = [otelcol.processor.memory_limiter.core.input]
            traces  = [otelcol.processor.memory_limiter.core.input]
          }
        }

        otelcol.processor.memory_limiter "core" {
          check_interval = "1s"
          limit          = "150MiB"

          output {
            metrics = [
              otelcol.exporter.prometheus.local.input
            ]
            logs    = [
              otelcol.exporter.loki.local.input
            ]
            traces  = [
              otelcol.exporter.otlp.tempo.receiver,
              otelcol.exporter.otlp.grafana_cloud_tempo.receiver
            ]
          }
        }

    envFrom:
    - secretRef:
        name: grafana-agent-datadog-credentials
    - secretRef:
        name: grafana-agent-lightstep-credentials
    - secretRef:
        name: grafana-agent-grafanacloud-credentials
  controller:
    replicas: 1
  # TODO: https://github.com/grafana/agent/pull/4094
  serviceMonitor:
    enabled: true
  ingress:
    enabled: true
    path: /
    faroPort: 12347
    pathType: Prefix
    hosts:
    - agent.homelab.portefaix.xyz
    tls: []
