# Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

---
global:
  resolve_timeout: 5m

time_intervals:
- name: business_hours_on
  time_intervals:
  - weekdays: ['monday:friday']
    times:
    - start_time: '08:00'
      end_time: '17:59'
- name: business_hours_oncall
  time_intervals:
  - weekdays: ['monday:friday']
    times:
    - start_time: '00:00'
      end_time: '07:59'
    - start_time: '18:00'
      end_time: '23:59'
- name: weekend_on
  time_intervals:
  - weekdays: ['saturday', 'sunday']
    times:
    - start_time: '10:00'
      end_time: '19:59'
- name: weekend_oncall
  time_intervals:
  - weekdays: ['saturday', 'sunday']
    times:
    - start_time: '00:00'
      end_time: '09:59'
    - start_time: '20:00'
      end_time: '23:59'
- name: holidays
  time_intervals:
  - months: ['december']
    days_of_month: ['24:25']
  - months: ['december']
    days_of_month: ['31']
  - months: ['january']
    days_of_month: ['1:2']

receivers:

- name: blackhole

- name: deadmanswitch
  webhook_configs:
  - url: "${AM_BETTERUPTIME_URL}"
    send_resolved: true
  # - url: "${AM_SQUADCAST_URL}"
  #   send_resolved: true
  - url: "${AM_STATUSCAKE_URL}"
    send_resolved: true

- name: slack
  slack_configs:
  - channel: '#portefaix-homelab-alerts'
    send_resolved: true
    color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
    api_url: "${AM_SLACK_URL}"
    icon_url: "https://avatars3.githubusercontent.com/u/3380462"
    title: |-
      [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
    text: >-
      {{ range .Alerts -}}
      *Alert:* {{ .Annotations.summary }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}
      *Description:* {{ .Annotations.description }}
      *Details:*
      {{ range .Labels.SortedPairs }}
        â€¢ *{{ .Name }}:* `{{ .Value }}`
      {{ end }}
      {{ end }}

    actions:
    - type: button
      text: 'Runbook :green_book:'
      url: '{{ (index .Alerts 0).Annotations.runbook_url }}'
    # - type: button
    #   text: 'Query :mag:'
    #   url: '{{ (index .Alerts 0).GeneratorURL }}'
    - type: button
      text: 'Dashboard :grafana:'
      url: '{{ (index .Alerts 0).Annotations.dashboard_url }}'
    # - type: button
    #   text: 'Silence :no_bell:'
    #   url: '{{ template "__alert_silence_link" . }}'

- name: grafana_heartbeat
  webhook_configs:
  - url: "${AM_GRAFANA_CLOUD_HEARTBEAT}"
    send_resolved: false
- name: grafana_oncall
  webhook_configs:
  - url: "${AM_GRAFANA_CLOUD_ON_CALL}"
    send_resolved: true

route:
  receiver: slack
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 5m
  repeat_interval: 1h
  routes:
  - receiver: deadmanswitch
    matchers:
    - alertname = Watchdog
    repeat_interval: 1m
    group_interval: 1m
  # - receiver: grafana_heartbeat
  #   matchers:
  #   - alertname = Watchdog
  #   repeat_interval: 1m
  #   group_interval: 1m

  - receiver: blackhole
    matchers:
    - alertname =~ KubeAPIDown|KubeSchedulerDown|KubeControllerManagerDown
  - receiver: blackhole
    matchers:
    - alertname = InfoInhibitor
    - severity =~ none|page

  - receiver: grafana_oncall
    matchers:
    - severity = critical
    mute_time_intervals:
    - business_hours_oncall
    - weekend_oncall
    - holidays

  - receiver: slack
    matchers:
    - severity = info
    mute_time_intervals:
    - weekend_oncall
    - holidays
  - receiver: slack
    matchers:
    - severity = warning
    mute_time_intervals:
    - weekend_oncall
    - holidays
  - receiver: slack
    matchers:
    - severity = critical
    active_time_intervals:
    - business_hours_oncall
    - weekend_oncall
    - holidays

templates:
- /etc/alertmanager/config/*.tmpl
