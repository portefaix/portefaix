# Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
apiVersion: s3.aws.crossplane.io/v1beta1
kind: Bucket
metadata:
  name: portefaix-krm-poc
  annotations:
    crossplane.io/external-name: portefaix-krm-poc
spec:
  forProvider:
    acl: private
    locationConstraint: eu-west-1
    publicAccessBlockConfiguration:
      blockPublicPolicy: true
    accelerateConfiguration:
      status: Enabled
    versioningConfiguration:
      status: Enabled
    tagging:
      tagSet:
      - key: Name
        value: portefaix-krm-poc
      - key: Service
        value: krm
      - key: Made-by
        value: crossplane
    objectLockEnabledForBucket: false
    serverSideEncryptionConfiguration:
      rules:
        - applyServerSideEncryptionByDefault:
            sseAlgorithm: AES256
    corsConfiguration:
      corsRules:
        - allowedMethods:
            - "GET"
          allowedOrigins:
            - "*"
          allowedHeaders:
            - "*"
          exposeHeaders:
            - "x-amz-server-side-encryption"
    lifecycleConfiguration:
      rules:
        - status: Enabled
          filter:
            prefix: "ola/"
          expiration:
            days: 15
    replicationConfiguration:
      roleRef:
        name: somerole
      rules:
        - destination:
            storageClass: STANDARD
            bucketRef:
              name: portefaix-krm-poc-repl
          deleteMarkerReplication:
            status: Disabled
          filter:
            prefix: ""
          priority: 0
          id: rule-1
          status: Enabled
  providerConfigRef:
    name: crossplane-aws
---
apiVersion: s3.aws.crossplane.io/v1beta1
kind: Bucket
metadata:
  name: portefaix-krm-poc-repl
  annotations:
    crossplane.io/external-name: portefaix-krm-poc-repl
spec:
  deletionPolicy: Delete
  forProvider:
    acl: private
    locationConstraint: eu-west-1
    paymentConfiguration:
      payer: BucketOwner
    serverSideEncryptionConfiguration:
      rules:
        - applyServerSideEncryptionByDefault:
            sseAlgorithm: AES256
    versioningConfiguration:
      status: Enabled
  providerConfigRef:
    name: crossplane-aws
---
apiVersion: s3.aws.crossplane.io/v1alpha3
kind: BucketPolicy
metadata:
  name: portefaix-krm-poc-public-all
spec:
  forProvider:
    region: eu-west-1
    bucketNameRef:
      name: portefaix-krm-poc
    rawPolicy: |
      {
        "Statement": [
          {
            "Action":"s3:ListBucket",
            "Effect":"Allow",
            "Principal":"*",
            "Resource":"arn:aws:s3:::portefaix-krm-poc"
          }
        ],
        "Version":"2012-10-17"
      }
  providerConfigRef:
    name: crossplane-aws
---
apiVersion: s3.aws.crossplane.io/v1alpha3
kind: BucketPolicy
metadata:
  name: portefaix-krm-poc-public-monitoring
spec:
  forProvider:
    region: eu-west-1
    bucketNameRef:
      name: portefaix-krm-poc
    policy:
      version: '2012-10-17'
      statements:
        - action:
            - s3:ListBucket
            - s3:GetBucketLocation
            - s3:ListBucketMultipartUploads
            - s3:PutBucketCORS
          effect: Allow
          principal:
            awsPrincipals:
              - iamUserArnSelector:
                  matchLabels:
                    monitoring: portefaix
          resource:
            - "arn:aws:s3:::portefaix-krm-poc"
          # condition:
          # - operatorKey: StringEquals
          #   conditions:
          #     - key: "aws:Key1"
          #       stringValue: "value1"
          #     - key: "aws:Key2"
          #       stringValue: "value2"
          # - operatorKey: IpAddress
          #   conditions:
          #     - key: "aws:SourceIp"
          #       stringValue: "192.0.2.0/24"
          # - operatorKey: NotIpAddress
          #   conditions:
          #     - key: "aws:SourceIp"
          #       stringValue: "192.0.2.188/32"
  providerConfigRef:
    name: crossplane-aws